#!/bin/sh
# shellcheck disable=SC2039

main() {
  set -eu
  if [ -n "${DEBUG:-}" ]; then
    set -x
  fi

  if [ -n "${2:-}" ]; then
    write_file "$1" "$2"
  else
    render_template "$1"
  fi
}

write_file() {
  local template="$1"
  local conf="$2"
  local conf_tmp
  conf_tmp="${conf}.$(date +%s)"

  render_template "$template" >"$conf_tmp"
  mv -f "$conf_tmp" "$conf"
}

render_template() {
  local template="$1"
  template="$(stat -f%R "$1")"
  local pluginget="${0%/*}/pluginget"

  # Load all `key='value'` entries into this process as shell variables
  eval "$("$pluginget" --all)"

  # For each key, add a `sed` substitution for a `@@$key@@` token with its
  # value to a `sed` command string, and finally invoke the `sed` command
  "$pluginget" --keys | {
    local args msg value
    msg="Generated from $template."
    msg="$msg Edit the template not this file or changes will be lost."
    args="-e 's,@@TEMPLATE@@,$msg,g'"

    while read -r key; do
      value="$("$pluginget" "$key")"
      args="$args -e 's,@@$key@@,$value,g'"
    done

    eval "sed $args '$template'"
  }
}

main "$@"
