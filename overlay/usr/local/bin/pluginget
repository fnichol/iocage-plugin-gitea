#!/bin/sh
# shellcheck disable=SC2039

main() {
  set -eu
  if [ -n "${DEBUG:-}" ]; then
    set -x
  fi

  local cfg_path="${CFG_PATH:-/var/db/gitea/iocage-plugin}"

  case "$1" in
    --all | -a)
      get_all_values "$cfg_path"
      ;;
    --keys | -k)
      get_all_keys "$cfg_path"
      ;;
    *)
      get_value_from_key "$cfg_path" "$1"
      ;;
  esac
}

get_value_from_key() {
  local cfg_path="$1"
  local key="$2"

  if [ -f "$cfg_path/$key" ]; then
    cat "$cfg_path/$key"
  else
    echo "xxx Key not found, key=$key cfg_path=$cfg_path" >&2
    return 1
  fi
}

get_all_keys() {
  local cfg_path="$1"

  find "$cfg_path" -type f -depth 1 -exec basename {} \;
}

get_all_values() {
  local cfg_path="$1"
  local value

  get_all_keys "$cfg_path" | while read -r key; do
    value="$(get_value_from_key "$cfg_path" "$key")"
    echo "$key='$value'"
  done
}

main "$@"
